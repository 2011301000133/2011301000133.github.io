---
layout: post
title: 【神经网络2】反向传播算法的数学表示
categories:
tags: 2B神经网络与TF
keywords:
description:
order: 251
---


## 知识准备
1. sigmoid的神经元是这样的  
$z=b+\sum\limits_ix_iw_i$  
$y=\dfrac{1}{1+e^{-z}}$  

2. sigmoid神经元的特点  
$\dfrac{dy}{dz}= y(1-y)$  


## 三层为例

下面的例子是一种特殊的神经网络：三层，最后一层是线性层，隐含层是sigmoid，cost Function是平方和。  
先以这种特殊的神经网络为例，说明反向传播算法。然后推广到更一般的的表达式  
### 变量定义
n表示第n个case/sample  
C表示误差，是一个数字
3层神经网络，M是输入层，I表示中间层，J表示输出层  
对于每个神经元：
- $v$表示神经元的输出
- $u$表示神经元的输入
- $\sigma()$表示神经元的激活函数  
（所以$v=\sigma(u)$）  
上标表示所在的层数，下标表示所在的个数，例如$v_i^l$表示$l$层第$i$个神经元的输出


### 梯度下降法
学习过程$w_{ij}(n+1)=\Delta w_{ij}(n)+w_{ij}(n)$  
其中$\Delta w_{ij}(n)=-\eta\dfrac{\partial e(n)}{\partial w_{ij}}$  
所以，问题在于如何求解$\dfrac{\partial e(n)}{\partial w_{ij}}$  
反向传播算法的目的就在于求解上面这个偏微分  

### 对于第n个case,J层情况
#### 1. 用链式法则拆分
$\dfrac{\partial e(n)}{\partial w_{ij}}
=\dfrac{\partial e}{\partial e_j}
\dfrac{\partial e_j}{\partial v_j}
\dfrac{\partial v_j}{\partial u_j}
\dfrac{\partial u_j}{\partial w_{ij}}$  
- 关于第一项  
$e=0.5\sum e_j^2$  
于是$\dfrac{\partial e}{\partial e_j}=e_j=t_j-v_j^J$  
- 关于第二项   
$e_j=t_j-v_j^J$  
于是$\dfrac{\partial e_j}{\partial v_j}=-1$  
- 关于第三项  
$v_j^J=\sigma(u_j^J)$  
于是$\dfrac{\partial v_j}{\partial u_j}=\sigma'(u_j^J)$  
- 关于第四项  
$u_j^J=\sum\limits_{i\in I}w_{ij}v_i^I $  
于是$\dfrac{\partial u_j}{\partial w_{ij}}=v_i^I$  


#### 2. 学习
定义梯度为：  
$\delta_j^J=
\dfrac{\partial e}{\partial e_j}
\dfrac{\partial e_j}{\partial v_j}
\dfrac{\partial v_j}{\partial u_j}$  


于是:  
$\dfrac{\partial e}{\partial w_{ij}}
=\delta_j^Jv^I_i$  
所以：  
$\Delta w_{ij}(n)=-\eta \delta_j^J v_i^I$  

### 对于第n个case，I层学习

(I层之前为M层)
$\Delta w_{mi}^I= - \eta \dfrac{\partial e}{\partial w_{mi}}$

用链式法则拆分  
$\dfrac{\partial e}{\partial w_{mi}}
=\dfrac{\partial e}{\partial v_i^I}
\dfrac{\partial v_i^I}{\partial u_i^I}
\dfrac{\partial u_i^I}{\partial w_{mi}}$  
- 其中，前两项为梯度：
$\delta_i^I=
\dfrac{\partial e}{\partial v_i}
\dfrac{\partial v_i}{\partial u_i}$  
    - 第一项为  
    $\dfrac{\partial e}{\partial v_i^I}=\sum\limits_{j\in J}\delta_j^Jw_{ij}$
    - 所以$\delta_i^I=
    \sum\limits_{j\in J}\delta_j^Jw_{ij}
    \dfrac{\partial v_i}{\partial u_i}$  


用梯度形式改写迭代式  
$\Delta w_{mi}^I=-\eta \delta_i^I v_m^M$  

## 更优美的形式

上面的推导中，思路是以$\dfrac{\partial C}{\partial w}$为核心，试图寻找权重$w$的最佳改进方向。  
在推导中发现，如果以梯度$\delta$为核心，算法看起来会更优美，并且更有一般性（本质上还是等价的）  
定义梯度$\delta_j^l=\dfrac{\partial C}{\partial u_j^l}$  
### BP1
输出层$\delta^L=\nabla_vC \odot \sigma'(u^L)$  
上式是向量形式表达的，解释如下：  
- $\odot$是向量对应项乘积(标量积)，称为 **Hadamard乘积**，或者 **Schur** 乘积  
- 标量形式：$\delta_j^L=\dfrac{\partial C}{\partial v_j}\dfrac{\partial v_j^L}{\partial u_j^L} ,\forall j$  


### BP2
使用$l+1$层的$\delta^{l+1}$来表示$\delta^l$  
$\delta^l=((w^{l+1})^T\delta^{l+1}))\odot \sigma'(u^l)$  
- 标量形式：$\delta_j^l=\dfrac{\partial C}{\partial u_j^l}=\sum_k\dfrac{\partial C}{\partial u_j^{l+1}}\dfrac{\partial u_k^{l+1}}{\partial v_j^l}\dfrac{\partial v_j^l}{\partial u_j^l}=\sum_k\delta_k^{l+1}w_{jk}^l \sigma'(u_j^l)$


### BP3
标量形式$\dfrac{\partial C}{\partial b_j^l}=\delta_j^l$  
向量形式$\dfrac{\partial C}{\partial b^l}=\delta^l$  
### BP4
标量形式$\dfrac{\partial C}{\partial w_{jk}^l}=v^{l-1}_k\delta_j^l$  
向量形式$\dfrac{\partial C}{\partial w}=v^{l-1}\delta^{l}$(其实是矩阵形式)  


## 附
反向传播算法的核心目的是为了求$\dfrac{\partial C}{\partial w}$,  
有一个看起来更简单的方案$\dfrac{\partial C}{\partial w_i}\approx \dfrac{C(w+\varepsilon e_i)-C(w)}{\varepsilon}$  
如果有n个w，需要计算n+1次C，计算量远大于反向传播算法。  

## 参考资料
http://michaelnielsen.org/
