---
layout: post
title: 【TensorFlow案例2】KNN
categories:
tags: 2B神经网络与TF
keywords:
description:
order: 290
---

*TensorFlow也可以用来做KNN*

## demo1
### step1：加载数据
```py
import pandas as pd
import tensorflow as tf

df = pd.read_csv('https://archive.ics.uci.edu/ml/machine-learning-databases/housing/housing.data',
                 names=['CRIM', 'ZN', 'INDUS', 'CHAS', 'NOX', 'RM', 'AGE', 'DIS', 'RAD', 'TAX', 'PTRATIO', 'B', 'LSTAT',
                        'MEDV'], sep='\s+', header=None)
df.drop(['ZN','CHAS','RAD'],axis=1,inplace=True)
X,Y=df.iloc[:,:10].values,df.iloc[:,10].values.reshape(-1,1)
from sklearn.model_selection import train_test_split
X_train,X_test,Y_train,Y_test=train_test_split(X,Y,test_size=0.2)

num_featurs=X.shape[1]
```

### step2：声明占位符
```py
sess=tf.Session()

k=4
batch_size=20

x_train=tf.placeholder(shape=[None,num_featurs],dtype=tf.float32)
x_test=tf.placeholder(shape=[None,num_featurs],dtype=tf.float32)
y_train=tf.placeholder(shape=[None,1],dtype=tf.float32)
y_test=tf.placeholder(shape=[None,1],dtype=tf.float32)


distance=tf.reduce_sum(tf.abs(x_train-tf.expand_dims(x_test,1)),reduction_indices=2)
# 返回一个距离矩阵（使用了tf的广播计算原理）
# 这里用的是l1范数。如果想用l2范数，只需要把tf.abs换成tf.quare，
```
### step3：预测阶段

```py
top_k_xvals, top_k_indices = tf.nn.top_k(-distance, k=k)
top_k_yvals = tf.gather(y_train, top_k_indices)
prediction=tf.reduce_mean(top_k_yvals,axis=1)
```


下面这个是《TensorFlow机器学习实战指南》中的代码，计算了距离权重。有一处错误，权重与距离成正比（正确算法应当是成反比）
```py
top_k_xvals, top_k_indices = tf.nn.top_k(-distance, k=k)
x_sums = tf.expand_dims(tf.reduce_sum(top_k_xvals, 1), 1)
x_sums_repeated = tf.matmul(x_sums, tf.ones((1, k), dtype=tf.float32))
x_val_weights = tf.expand_dims(tf.div(top_k_xvals, x_sums_repeated), 1)
# 主要为了用距离做权重

top_k_yvals = tf.gather(y_train, top_k_indices)
prediction = tf.squeeze(tf.matmul(x_val_weights, top_k_yvals), squeeze_dims=[1])
# mse = tf.div(tf.square(prediction - y_test), batch_size)
```
### step4：预测并验证结果
```py
Y_test_predict=sess.run(prediction,feed_dict={x_train:X_train,x_test:X_test,y_train:Y_train})

from sklearn.metrics import r2_score
r2_score(Y_test,Y_test_predict)
# sess.run(y_train,feed_dict={y_train:Y_train})

# 附上一个sklearn的实现
from sklearn.neighbors import KNeighborsRegressor
knr=KNeighborsRegressor(n_neighbors=k)
knr.fit(X_train,Y_train)
Y_test_predict1=knr.predict(X_test)
r2_score(Y_test,Y_test_predict1)

```

## 参考资料
Nick McClure:《TensorFlow机器学习实战指南》 机械工业出版社  
《深度学习》 人民邮电出版社  
王琛：《深度学习原理与TensorFlow实战》 电子工业出版社  
《TensorFlow技术解析与实战》 人民邮电出版社  
《TensorFlow实战》 电子工业出版社  
《TensorFlow实战Google深度学习框架》 电子工业出版社
